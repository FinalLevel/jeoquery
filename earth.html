<!DOCTYPE html>
<html>
    
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>jeoquery examples</title>
        <link rel="stylesheet" href="http://twitter.github.com/bootstrap/assets/css/bootstrap.css"
        />
        <link rel="stylesheet" href="http://twitter.github.com/bootstrap/assets/css/bootstrap-responsive.css"
        />
        <link rel="stylesheet" href="jeoquery.css" />
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.2.1/bootstrap.min.js"></script>
        <script type="text/javascript" src="jstree/jquery.jstree.js"></script>
        <script type="text/javascript" src="jeoquery.js"></script>
    </head>
    
    <body class="container">
        <script type="text/javascript">
            function getPopoverContent(g) {
                var c = '<table class="table table-striped"><thead>';
                c += '<tr><th>Key</th><th>Value</th></tr></thead><tbody>';
                for (var k in g) {
                    c += '<tr><td>' + k + '</td><td>' + g[k] + '</td></tr>';
                }
                return c + '</tbody></table>';
            }
            $(function () {
                // Set geonames user
                jeoquery.userName = 'tompi';
                // Create tree with "Earth" node
                var earth = {
                    data: 'Earth',
                    state: 'closed',
                    attr: {
                        id: 6295630
                    }
                };
                var tree = $("#debug").jstree({
                    "plugins": ["themes", "ui", "json_data", "types"],
                    "json_data": {
                        data: earth
                    },
                    "types": {
                        "types": {
                            "max_children": -2,
                            "max_depth": -2,
                            "default": {
                                "valid_children": ["default"],
                                "select_node": function (e) {
                                    this.toggle_node(e);
                                    return false;
                                }
                            }
                        }
                    }
                });
                // Bind function to lookup children to open-event
                tree.bind("open_node.jstree", function (e, data) {
                    var node = data.args[0];
                    if (!node.data('openedbefore')) {
                        node.data('openedbefore', 'true');
                        var geoId = node.attr('id');
                        // Actual geonames lookup
                        jeoquery.children(function (obj) {
                            if (obj && obj.geonames) {
                                // Loop over results(children) and add them as nodes
                                for (var i = 0; i < obj.geonames.length; i++) {
                                    var gn = obj.geonames[i];
                                    var data = {
                                        data: gn.name,
                                        attr: {
                                            id: gn.geonameId
                                        }
                                    };
                                    if (gn.numberOfChildren) data.state = 'closed';
                                    tree.jstree('create_node', node, 'last', data, function () {
                                        $('#' + gn.geonameId + ' a').popover({
                                            title: gn.name,
                                            content: getPopoverContent(gn)
                                        });
                                    });
                                }
                            }
                        }, geoId);
                    }
                });
            });
        </script>
        <div class="row">
            <div class="well">
                <span style="font-size: 40px; float: right; padding-top: 20px; color: #363;">GeoNames</span>
                <img src="http://www.geonames.org/img/globe.gif" style="float: right;"
                alt="Geonames logo" />
                <span style="font-size: 76px; float: right; padding-top: 20px;">+</span>
                <img src="http://jquery.org/wp-content/uploads/2010/01/JQuery_logo_color_onwhite-300x74.png"
                style="float: right;" alt="jQuery logo" />
                <h2>jeoQuery
                    <small>by Thomas Haukland</small>
                </h2>
                <h3>Browse geonames hierarchy methods</h3>
            </div>
        </div>
        <div class="row">
            <div>
                <h3>Drill down and hover the nodes</h3>
                <p>This demo attaches an event on the jstree open node, and calls the "children"
                    jsonp service at geonames to get the children, and then adds it into the
                    tree.</p>
                <div id="debug" class="well"></div>
            </div>
        </div>
    </body>

</html>
